<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hotel Complimentary Ticket Registration • WGP#1</title>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

  <style>
    :root {
      --primary:#f37021;
      --border:#e5e7eb;
      --ok:#16a34a;
      --font-base:clamp(23px, 2.6vw, 26px);
      --font-label:clamp(22px, 2.5vw, 24px);
      --font-title:clamp(31px, 3.6vw, 39px);
      --font-note:clamp(18px, 2vw, 20px);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:#f3f4f6;
      color:#111827;
      font-size:var(--font-base);
    }

    .header img {
      display:block;
      width:100%;
      height:auto;
    }

    .container {
      width:100%;
      max-width:none;
      margin:0;
      padding:20px 10px 32px;
    }

    @media (min-width:1024px){
      .container{
        max-width:1200px;
        margin:0 auto;
        padding:28px 24px 40px;
      }
    }

    .card {
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 40px rgba(15,23,42,0.08);
      border:1px solid #e5e7eb;
      overflow:hidden;
    }

    .head {
      padding:20px 20px 12px;
      border-bottom:1px solid var(--border);
    }

    .head h1 {
      margin:0 0 4px;
      font-size:var(--font-title);
      font-weight:900;
    }

    .head p {
      margin:0;
      font-size:var(--font-note);
      color:#4b5563;
    }

    .body {
      padding:20px;
    }

    .row {
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
      margin-bottom:18px;
    }

    @media (min-width:760px) {
      .row.two {
        grid-template-columns:1fr 1fr;
      }
    }

    label.title {
      font-weight:800;
      font-size:var(--font-label);
      margin-bottom:8px;
      display:block;
    }

    .en-label {
      font-weight:600;
      color:#6b7280;
      font-size:calc(var(--font-label) - 2px);
      margin-left:4px;
    }

    input, select {
      width:100%;
      padding:16px 18px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:var(--font-base);
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }

    input:focus, select:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(243,112,33,.18);
    }

    .note {
      font-size:var(--font-note);
      color:#6b7280;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:18px 24px;
      border-radius:18px;
      border:none;
      cursor:pointer;
      font-weight:800;
      font-size:var(--font-base);
    }

    .btn-primary {
      width:100%;
      background:var(--primary);
      color:#fff;
      box-shadow:0 14px 32px -18px rgba(248,113,22,0.9);
    }

    .btn-primary:disabled {
      opacity:.6;
      cursor:default;
      box-shadow:none;
    }

    .btn-secondary {
      width:100%;
      margin-top:16px;
      background:#111827;
      color:#fff;
    }

    .footer {
      margin-top:12px;
      text-align:center;
      font-size:var(--font-note);
      color:#9ca3af;
    }

    .consent-box {
      padding:16px 16px 12px;
      border-radius:16px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      margin-top:4px;
    }

    .consent-check {
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin-top:12px;
      font-size:var(--font-base);
    }

    .consent-check input[type="checkbox"] {
      flex:0 0 auto;
      width:1.4em;
      height:1.4em;
      margin-top:0.3em;
      accent-color:var(--primary);
    }

    .hidden { display:none!important; }

    .success {
      margin-top:20px;
      padding:20px 22px;
      border-radius:18px;
      background:#fff7ef;
      border:2px solid #fdba74;
      color:#7c2d12;
      font-size:var(--font-note);
      text-align:center;
      box-shadow:0 8px 24px rgba(248,113,22,0.15);
    }

    .error {
      margin-top:20px;
      padding:16px 18px;
      border-radius:14px;
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#b91c1c;
      font-size:var(--font-note);
    }

    .success-title-main {
      font-size:clamp(28px, 3.2vw, 34px);
      font-weight:900;
      margin:0 0 6px;
      color:#c2410c;
    }

    .success-title-sub {
      font-size:var(--font-note);
      font-weight:700;
      margin:0 0 14px;
      color:#9a3412;
    }

    .success-ref-label {
      margin-top:16px;
      font-weight:700;
      font-size:var(--font-note);
    }

    .success-ref-value {
      font-size:clamp(32px, 3.8vw, 40px);
      font-weight:900;
      letter-spacing:0.08em;
      margin-top:4px;
      color:#b91c1c;
    }

    .success-name-label {
      margin-top:14px;
      font-weight:700;
      font-size:var(--font-note);
    }

    .success-name-value {
      margin-top:4px;
      font-size:var(--font-base);
      font-weight:800;
    }
  .success h2 {
  font-size:clamp(28px, 3.2vw, 34px);
  font-weight:900;
  margin:0 0 12px;
  color:#c2410c;
}

.success-text {
  margin:0 0 16px;
}

.success-ref-label,
.success-name-label {
  margin-top:12px;
  font-weight:700;
}

.success-ref {
  font-size:clamp(32px, 3.8vw, 40px);
  font-weight:900;
  letter-spacing:0.08em;
  margin:4px 0 0;
  color:#b91c1c;
}

.success-name {
  margin-top:6px;
  font-weight:800;
}

    @media (min-width:768px) and (pointer:coarse) {
      select, select option {
        font-size:26px;
        line-height:1.6;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="Header.png" alt="WGP#1 Waterjet World Cup 2025 Header">
  </div>

  <main class="container">
    <!-- PAGE 1 : FORM -->
    <div id="page-form">
      <div class="card">
        <div class="head">
          <h1>Hotel Complimentary Ticket Registration</h1>
          <p>ลงทะเบียนเพื่อรับตั๋ว Complimentary Ticket • 1 ใบใช้เข้างานได้ 1 วัน</p>
        </div>

        <form class="body" id="hotel-form">
          <!-- ชื่อ (TH/EN) -->
          <div class="row two">
            <div>
              <label class="title">
                ชื่อจริง
                <span class="en-label">/ First Name (TH or EN)</span> *
              </label>
              <input id="first_name" required>
            </div>
            <div>
              <label class="title">
                นามสกุล
                <span class="en-label">/ Last Name (TH or EN)</span> *
              </label>
              <input id="last_name" required>
            </div>
          </div>

          <!-- เพศ / อายุ (ช่วงอายุ) -->
          <div class="row two">
            <div>
              <label class="title">
                เพศ
                <span class="en-label">/ Gender</span> *
              </label>
              <select id="gender" required>
                <option value="">— เลือกเพศ / Select —</option>
                <option value="Male">ชาย / Male</option>
                <option value="Female">หญิง / Female</option>
                <option value="Other">อื่น ๆ / Other</option>
              </select>
            </div>
            <div>
              <label class="title">
                อายุ
                <span class="en-label">/ Age</span> *
              </label>
              <select id="age_group" required>
                <option value="">— เลือกช่วงอายุ / Select —</option>
                <option value="Under 18">ต่ำกว่า 18 ปี / Under 18 Yrs.</option>
                <option value="18-25">18–25 ปี / 18–25 Yrs.</option>
                <option value="26-40">26–40 ปี / 26–40 Yrs.</option>
                <option value="41-60">41–60 ปี / 41–60 Yrs.</option>
                <option value="60+">60 ปีขึ้นไป / 60+ Yrs.</option>
              </select>
            </div>
          </div>

          <!-- เบอร์ / โรงแรม -->
          <div class="row two">
            <div>
              <label class="title">
                โรงแรมที่คุณเข้าพัก
                <span class="en-label">/ Hotel You Are Staying At</span> *
              </label>
              <input id="hotel_name" required placeholder="เช่น Royal Cliff Beach Hotel">
            </div>
          </div>

          <!-- Country -->
          <div class="row">
            <div>
              <label class="title">
                ประเทศที่อาศัย
                <span class="en-label">/ Country of Residence</span> *
              </label>
              <select id="country" required>
                <option value="">— เลือกประเทศ / Select Country —</option>
                <!-- (รายการประเทศเดิมทั้งหมด) -->
                <option value="Afghanistan">Afghanistan</option>
                <option value="Albania">Albania</option>
                <option value="Algeria">Algeria</option>
                <option value="Andorra">Andorra</option>
                <option value="Angola">Angola</option>
                <option value="Argentina">Argentina</option>
                <option value="Armenia">Armenia</option>
                <option value="Australia">Australia</option>
                <option value="Austria">Austria</option>
                <option value="Azerbaijan">Azerbaijan</option>
                <option value="Bahamas">Bahamas</option>
                <option value="Bahrain">Bahrain</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Barbados">Barbados</option>
                <option value="Belarus">Belarus</option>
                <option value="Belgium">Belgium</option>
                <option value="Belize">Belize</option>
                <option value="Benin">Benin</option>
                <option value="Bhutan">Bhutan</option>
                <option value="Bolivia">Bolivia</option>
                <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                <option value="Botswana">Botswana</option>
                <option value="Brazil">Brazil</option>
                <option value="Brunei">Brunei</option>
                <option value="Bulgaria">Bulgaria</option>
                <option value="Burkina Faso">Burkina Faso</option>
                <option value="Burundi">Burundi</option>
                <option value="Cambodia">Cambodia</option>
                <option value="Cameroon">Cameroon</option>
                <option value="Canada">Canada</option>
                <option value="Cape Verde">Cape Verde</option>
                <option value="Chad">Chad</option>
                <option value="Chile">Chile</option>
                <option value="China">China</option>
                <option value="Colombia">Colombia</option>
                <option value="Comoros">Comoros</option>
                <option value="Costa Rica">Costa Rica</option>
                <option value="Croatia">Croatia</option>
                <option value="Cuba">Cuba</option>
                <option value="Cyprus">Cyprus</option>
                <option value="Czech Republic">Czech Republic</option>
                <option value="Denmark">Denmark</option>
                <option value="Djibouti">Djibouti</option>
                <option value="Dominica">Dominica</option>
                <option value="Dominican Republic">Dominican Republic</option>
                <option value="Ecuador">Ecuador</option>
                <option value="Egypt">Egypt</option>
                <option value="El Salvador">El Salvador</option>
                <option value="Estonia">Estonia</option>
                <option value="Ethiopia">Ethiopia</option>
                <option value="Fiji">Fiji</option>
                <option value="Finland">Finland</option>
                <option value="France">France</option>
                <option value="Gabon">Gabon</option>
                <option value="Gambia">Gambia</option>
                <option value="Georgia">Georgia</option>
                <option value="Germany">Germany</option>
                <option value="Ghana">Ghana</option>
                <option value="Greece">Greece</option>
                <option value="Guatemala">Guatemala</option>
                <option value="Guinea">Guinea</option>
                <option value="Haiti">Haiti</option>
                <option value="Honduras">Honduras</option>
                <option value="Hong Kong">Hong Kong</option>
                <option value="Hungary">Hungary</option>
                <option value="Iceland">Iceland</option>
                <option value="India">India</option>
                <option value="Indonesia">Indonesia</option>
                <option value="Iran">Iran</option>
                <option value="Iraq">Iraq</option>
                <option value="Ireland">Ireland</option>
                <option value="Israel">Israel</option>
                <option value="Italy">Italy</option>
                <option value="Jamaica">Jamaica</option>
                <option value="Japan">Japan</option>
                <option value="Jordan">Jordan</option>
                <option value="Kazakhstan">Kazakhstan</option>
                <option value="Kenya">Kenya</option>
                <option value="Korea">Korea</option>
                <option value="Kuwait">Kuwait</option>
                <option value="Laos">Laos</option>
                <option value="Latvia">Latvia</option>
                <option value="Lebanon">Lebanon</option>
                <option value="Liberia">Liberia</option>
                <option value="Libya">Libya</option>
                <option value="Lithuania">Lithuania</option>
                <option value="Luxembourg">Luxembourg</option>
                <option value="Macau">Macau</option>
                <option value="Madagascar">Madagascar</option>
                <option value="Malaysia">Malaysia</option>
                <option value="Maldives">Maldives</option>
                <option value="Mali">Mali</option>
                <option value="Malta">Malta</option>
                <option value="Mexico">Mexico</option>
                <option value="Moldova">Moldova</option>
                <option value="Mongolia">Mongolia</option>
                <option value="Morocco">Morocco</option>
                <option value="Mozambique">Mozambique</option>
                <option value="Myanmar">Myanmar</option>
                <option value="Namibia">Namibia</option>
                <option value="Nepal">Nepal</option>
                <option value="Netherlands">Netherlands</option>
                <option value="New Zealand">New Zealand</option>
                <option value="Nicaragua">Nicaragua</option>
                <option value="Niger">Niger</option>
                <option value="Nigeria">Nigeria</option>
                <option value="North Macedonia">North Macedonia</option>
                <option value="Norway">Norway</option>
                <option value="Oman">Oman</option>
                <option value="Pakistan">Pakistan</option>
                <option value="Panama">Panama</option>
                <option value="Papua New Guinea">Papua New Guinea</option>
                <option value="Paraguay">Paraguay</option>
                <option value="Peru">Peru</option>
                <option value="Philippines">Philippines</option>
                <option value="Poland">Poland</option>
                <option value="Portugal">Portugal</option>
                <option value="Qatar">Qatar</option>
                <option value="Romania">Romania</option>
                <option value="Russia">Russia</option>
                <option value="Rwanda">Rwanda</option>
                <option value="Saudi Arabia">Saudi Arabia</option>
                <option value="Senegal">Senegal</option>
                <option value="Serbia">Serbia</option>
                <option value="Singapore">Singapore</option>
                <option value="Slovakia">Slovakia</option>
                <option value="Slovenia">Slovenia</option>
                <option value="South Africa">South Africa</option>
                <option value="Spain">Spain</option>
                <option value="Sri Lanka">Sri Lanka</option>
                <option value="Sweden">Sweden</option>
                <option value="Switzerland">Switzerland</option>
                <option value="Taiwan">Taiwan</option>
                <option value="Tajikistan">Tajikistan</option>
                <option value="Tanzania">Tanzania</option>
                <option value="Thailand">Thailand</option>
                <option value="Turkey">Turkey</option>
                <option value="Uganda">Uganda</option>
                <option value="Ukraine">Ukraine</option>
                <option value="United Arab Emirates">United Arab Emirates</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="United States">United States</option>
                <option value="Uruguay">Uruguay</option>
                <option value="Uzbekistan">Uzbekistan</option>
                <option value="Venezuela">Venezuela</option>
                <option value="Vietnam">Vietnam</option>
                <option value="Yemen">Yemen</option>
                <option value="Zambia">Zambia</option>
                <option value="Zimbabwe">Zimbabwe</option>
              </select>
            </div>
          </div>

          <!-- Consent -->
          <div class="row">
            <div>
              <label class="title">
                ยินยอมให้เก็บข้อมูล
                <span class="en-label">/ Consent</span> *
              </label>
              <div class="consent-box">
                <p class="note">
                  EN: I understand that this form is used to register for a complimentary ticket for the
                  WGP#1 Waterjet World Cup 2025. My information (name, contact, hotel, and country) may be
                  used by the event organizer and hotel partners for verification and internal reporting only.
                  My data will not be sold or shared with unrelated third parties.
                </p>
                <p class="note">
                  TH: ข้าพเจ้าขอรับรองว่าข้อมูลที่ให้ไว้เป็นความจริง และยินยอมให้ผู้จัดงานและโรงแรมคู่ค้า
                  ใช้ข้อมูลนี้เพื่อการยืนยันสิทธิ์ตั๋วเข้างาน และการจัดทำรายงานภายในเท่านั้น
                  ข้อมูลจะไม่ถูกขายหรือเปิดเผยต่อบุคคลภายนอกที่ไม่เกี่ยวข้อง
                </p>

                <label class="consent-check">
                  <input type="checkbox" id="consent" required>
                  <span>
                    ฉันได้อ่านและยินยอมให้เก็บและใช้ข้อมูลตามที่ระบุข้างต้น<br>
                    I have read and consent to the data usage described above.
                  </span>
                </label>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="submit-btn">
            ส่งข้อมูลลงทะเบียน • Submit Registration
          </button>

          <div id="message" class="hidden"></div>
        </form>
      </div>
    </div>

    <!-- PAGE 2 : SUCCESS -->
<div id="page-success" class="hidden">
  <div class="card">
    <div class="body">
      <!-- กล่องข้อความออเรนจ์ -->
      <div id="confirm-card" class="success">
        <h2>ลงทะเบียนสำเร็จ<br>Registration Successful</h2>

        <p class="success-text">
          <strong>TH:</strong> กรุณาแคปหน้าจอนี้ เพื่อแสดงแก่จุดลงทะเบียนหน้างาน<br>
          <strong>EN:</strong> Please take a screenshot of this screen and show it at the registration point.
        </p>

        <p class="success-ref-label">
          หมายเลข Reference ของคุณคือ<br>
          Your Reference No. is
        </p>

        <p class="success-ref" id="c-ref">H-0000</p>

        <p class="success-name-label">
          ชื่อ–นามสกุล / Full Name
        </p>
        <p class="success-name" id="c-name">John Doe</p>
      </div>

      <!-- ปุ่มอยู่นอกกล่องข้อความแล้ว -->
      <button type="button"
              class="btn btn-secondary success-back-btn"
              id="new-register-btn">
        กลับสู่หน้าหลัก / Back to home page
      </button>
    </div>
  </div>
</div>

    <div class="footer">
      © 2025 WGP#1 Waterjet World Cup
    </div>
  </main>

<script>
/* Supabase */
const SUPABASE_URL = 'https://mhecpnqwwxspxfhdvzsc.supabase.co';
const SUPABASE_ANON_KEY =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZWNwbnF3d3hzcHhmaGR2enNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDc0MjEsImV4cCI6MjA3ODU4MzQyMX0.ONaEMqU6BHuMSywE3Yvtbj78NqBbecI18amsD18Cgnc';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Elements */
const pageForm      = document.getElementById('page-form');
const pageSuccess   = document.getElementById('page-success');
const form          = document.getElementById('hotel-form');
const submitBtn     = document.getElementById('submit-btn');
const messageBox    = document.getElementById('message');
const countryEl     = document.getElementById('country');

/* Local storage */
function saveLocal(payload) {
  localStorage.setItem("hotel_registration", JSON.stringify(payload));
}
function loadLocal() {
  const data = localStorage.getItem("hotel_registration");
  return data ? JSON.parse(data) : null;
}

/* Fill confirmation card */
function fillConfirmCard(p) {
  document.getElementById('c-name').textContent =
    `${p.first_name || ''} ${p.last_name || ''}`.trim();
  document.getElementById('c-ref').textContent   = p.registration_ref || '-';
}

/* Show success page */
function showSuccessPage(payload) {
  fillConfirmCard(payload);
  pageForm.classList.add('hidden');
  pageSuccess.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* Insert to Supabase */
async function submitToSupabase(payload) {
  const { error } = await sb
    .from('hotel_complimentary_tickets')
    .insert({
      first_name:       payload.first_name,
      last_name:        payload.last_name,
      gender:           payload.gender,
      age_group:        payload.age_group,
      phone:            '',                 // ใส่สตริงว่างกัน not-null error
      hotel_name:       payload.hotel_name,
      country:          payload.country,
      thai_province:    null,
      consent:          payload.consent,
      registration_ref: payload.registration_ref
    }, { returning: 'minimal' });

  if (error) {
    console.error('[Supabase insert error]', error);
    throw error;
  }
}

/* Reference ID แบบสุ่ม H-0000 – H-9999 (ไม่ซ้ำในฐานข้อมูล) */
async function createReference() {
  const MAX_TRIES = 10;

  for (let i = 0; i < MAX_TRIES; i++) {
    const num  = Math.floor(Math.random() * 10000);  // 0–9999
    const code = 'H-' + String(num).padStart(4, '0');

    const { error, count } = await sb
      .from('hotel_complimentary_tickets')
      .select('id', { count: 'exact', head: true })
      .eq('registration_ref', code);

    if (error) {
      console.error('[Supabase check ref error]', error);
      throw error;
    }

    if (!count) {
      return code;    // ใช้ code นี้ได้
    }
  }

  throw new Error('Cannot generate unique reference ID. Please try again.');
}

/* Submit handler */
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  messageBox.className = 'hidden';
  messageBox.textContent = '';

  const payload = {
    first_name:   document.getElementById('first_name').value.trim(),
    last_name:    document.getElementById('last_name').value.trim(),
    gender:       document.getElementById('gender').value,
    age_group:    document.getElementById('age_group').value,
    hotel_name:   document.getElementById('hotel_name').value.trim(),
    country:      countryEl.value,
    consent:      document.getElementById('consent').checked,
  };

  submitBtn.disabled = true;
  submitBtn.textContent = 'กำลังบันทึก... / Submitting...';

  try {
    // สร้าง Ref ID แบบสุ่มไม่ซ้ำ
    payload.registration_ref = await createReference();

    await submitToSupabase(payload);
    saveLocal(payload);
    showSuccessPage(payload);
    form.reset();
  } catch (err) {
    console.error(err);
    messageBox.className = 'error';
    messageBox.textContent =
      'เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองอีกครั้ง หรือแจ้งเจ้าหน้าที่.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ส่งข้อมูลลงทะเบียน • Submit Registration';
  }
});

/* New Registration button */
document.getElementById('new-register-btn').addEventListener('click', () => {
  pageSuccess.classList.add('hidden');
  pageForm.classList.remove('hidden');
  messageBox.className = 'hidden';
  messageBox.textContent = '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* On load */
document.addEventListener("DOMContentLoaded", () => {
  const data = loadLocal();
  if (data) {
    showSuccessPage(data);
  }
});
</script>
</body>
</html>
