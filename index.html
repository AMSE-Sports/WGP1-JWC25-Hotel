<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hotel Complimentary Ticket Registration • WGP#1</title>

  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

  <style>
    :root {
      --primary:#f37021;
      --border:#e5e7eb;
      --ok:#16a34a;
      --font-base:clamp(23px, 2.6vw, 26px);
      --font-label:clamp(22px, 2.5vw, 24px);
      --font-title:clamp(31px, 3.6vw, 39px);
      --font-note:clamp(18px, 2vw, 20px);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:#f3f4f6;
      color:#111827;
      font-size:var(--font-base);
    }

    .header img {
      display:block;
      width:100%;
      height:auto;
    }

    .container {
      width:100%;
      max-width:none;
      margin:0;
      padding:20px 10px 32px;
    }

    @media (min-width:1024px){
      .container{
        max-width:1200px;
        margin:0 auto;
        padding:28px 24px 40px;
      }
    }

    .card {
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 40px rgba(15,23,42,0.08);
      border:1px solid #e5e7eb;
      overflow:hidden;
    }

    .head {
      padding:20px 20px 12px;
      border-bottom:1px solid var(--border);
    }

    .head h1 {
      margin:0 0 4px;
      font-size:var(--font-title);
      font-weight:900;
    }

    .head p {
      margin:0;
      font-size:var(--font-note);
      color:#4b5563;
    }

    .body {
      padding:20px;
    }

    .row {
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
      margin-bottom:18px;
    }

    @media (min-width:760px) {
      .row.two {
        grid-template-columns:1fr 1fr;
      }
    }

    label.title {
      font-weight:800;
      font-size:var(--font-label);
      margin-bottom:8px;
      display:block;
    }

    .en-label {
      font-weight:600;
      color:#6b7280;
      font-size:calc(var(--font-label) - 2px);
      margin-left:4px;
    }

    input, select {
      width:100%;
      padding:16px 18px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:var(--font-base);
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }

    input:focus, select:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(243,112,33,.18);
    }

    .note {
      font-size:var(--font-note);
      color:#6b7280;
    }

    .btn {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:18px 24px;
      border-radius:18px;
      border:none;
      cursor:pointer;
      font-weight:800;
      font-size:var(--font-base);
    }

    .btn-primary {
      width:100%;
      background:var(--primary);
      color:#fff;
      box-shadow:0 14px 32px -18px rgba(248,113,22,0.9);
    }

    .btn-primary:disabled {
      opacity:.6;
      cursor:default;
      box-shadow:none;
    }

    .btn-secondary {
      width:100%;
      margin-top:16px;
      background:#111827;
      color:#fff;
    }

    .footer {
      margin-top:12px;
      text-align:center;
      font-size:var(--font-note);
      color:#9ca3af;
    }

    .consent-box {
      padding:16px 16px 12px;
      border-radius:16px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      margin-top:4px;
    }

    .consent-check {
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin-top:12px;
      font-size:var(--font-base);
    }

    .consent-check input[type="checkbox"] {
      flex:0 0 auto;
      width:1.4em;
      height:1.4em;
      margin-top:0.3em;
      accent-color:var(--primary);
    }

    .hidden { display:none!important; }

    .success {
      margin-top:20px;
      padding:16px 18px;
      border-radius:14px;
      background:#ecfdf3;
      border:1px solid #bbf7d0;
      color:#166534;
      font-size:var(--font-note);
    }

    .error {
      margin-top:20px;
      padding:16px 18px;
      border-radius:14px;
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#b91c1c;
      font-size:var(--font-note);
    }

    /* กล่อง "กรุณาแคปหน้าจอ" สีแดง */
    .screenshot-box {
      margin-top:22px;
      padding:20px 22px;
      border-radius:18px;
      border:3px solid #dc2626;
      background:#fee2e2;
      color:#7f1d1d;
      font-size:clamp(20px, 2.5vw, 24px);
      font-weight:800;
      text-align:center;
      box-shadow:0 0 0 3px #fecaca;
    }

    .screenshot-box strong {
      display:block;
      margin-bottom:4px;
    }

    @media (min-width:768px) and (pointer:coarse) {
      select, select option {
        font-size:26px;
        line-height:1.6;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="Header.png" alt="WGP#1 Waterjet World Cup 2025 Header">
  </div>

  <main class="container">
    <!-- PAGE 1 : FORM -->
    <div id="page-form">
      <div class="card">
        <div class="head">
          <h1>Hotel Complimentary Ticket Registration</h1>
          <p>ลงทะเบียนเพื่อรับตั๋ว Complimentary Ticket • 1 ใบใช้เข้างานได้ 1 วัน</p>
        </div>

        <form class="body" id="hotel-form">
          <!-- ชื่อ (TH/EN) -->
          <div class="row two">
            <div>
              <label class="title">
                ชื่อจริง
                <span class="en-label">/ First Name (TH or EN)</span> *
              </label>
              <input id="first_name" required>
            </div>
            <div>
              <label class="title">
                นามสกุล
                <span class="en-label">/ Last Name (TH or EN)</span> *
              </label>
              <input id="last_name" required>
            </div>
          </div>

          <!-- เพศ / อายุ (ช่วงอายุ) -->
          <div class="row two">
            <div>
              <label class="title">
                เพศ
                <span class="en-label">/ Gender</span> *
              </label>
              <select id="gender" required>
                <option value="">— เลือกเพศ / Select —</option>
                <option value="Male">ชาย / Male</option>
                <option value="Female">หญิง / Female</option>
                <option value="Other">อื่น ๆ / Other</option>
              </select>
            </div>
            <div>
              <label class="title">
                อายุ
                <span class="en-label">/ Age</span> *
              </label>
              <select id="age_group" required>
                <option value="">— เลือกช่วงอายุ / Select —</option>
                <option value="Under 18">ต่ำกว่า 18 ปี / Under 18</option>
                <option value="18-25">18–25 ปี / 18–25</option>
                <option value="26-40">26–40 ปี / 26–40</option>
                <option value="41-60">41–60 ปี / 41–60</option>
                <option value="60+">60 ปีขึ้นไป / 60+</option>
              </select>
            </div>
          </div>

          <!-- เบอร์ / โรงแรม -->
          <div class="row two">
            <div>
              <label class="title">
                เบอร์ติดต่อ
                <span class="en-label">/ Phone Number</span> *
              </label>
              <input id="phone" type="tel" required placeholder="เช่น 0812345678">
            </div>

            <div>
              <label class="title">
                โรงแรมที่คุณเข้าพัก
                <span class="en-label">/ Hotel You Are Staying At</span> *
              </label>
              <input id="hotel_name" required placeholder="เช่น Royal Cliff Beach Hotel">
            </div>
          </div>

          <!-- Country / Province -->
          <div class="row two">
            <div>
              <label class="title">
                ประเทศที่อาศัย
                <span class="en-label">/ Country of Residence</span> *
              </label>
              <select id="country" required>
                <option value="">— เลือกประเทศ / Select Country —</option>
                <option value="Thailand">Thailand</option>
                <option value="Australia">Australia</option>
                <option value="China">China</option>
                <option value="France">France</option>
                <option value="Germany">Germany</option>
                <option value="India">India</option>
                <option value="Japan">Japan</option>
                <option value="Korea">Korea</option>
                <option value="Malaysia">Malaysia</option>
                <option value="Singapore">Singapore</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="United States">United States</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div id="province-wrapper" class="hidden">
              <label class="title">
                จังหวัดที่อาศัย (สำหรับผู้พำนักในประเทศไทย)
                <span class="en-label">/ Province (for Residents in Thailand)</span>
              </label>
              <select id="thai_province">
                <option value="">— เลือกจังหวัด / Select Province —</option>
                <!-- (รายชื่อจังหวัดทั้งหมดเหมือนเดิม) -->
                <option value="กรุงเทพมหานคร">กรุงเทพมหานคร</option>
                <!-- ... ตัดทอนเพื่อความสั้น สามารถใช้ชุดเดิมของคุณได้เลย ... -->
              </select>
            </div>
          </div>

          <!-- Consent -->
          <div class="row">
            <div>
              <label class="title">
                ยินยอมให้เก็บข้อมูล
                <span class="en-label">/ Consent</span> *
              </label>
              <div class="consent-box">
                <p class="note">
                  EN: I understand that this form is used to register for a complimentary ticket for the
                  WGP#1 Waterjet World Cup 2025. My information (name, contact, hotel, and country) may be
                  used by the event organizer and hotel partners for verification and internal reporting only.
                  My data will not be sold or shared with unrelated third parties.
                </p>
                <p class="note">
                  TH: ข้าพเจ้าขอรับรองว่าข้อมูลที่ให้ไว้เป็นความจริง และยินยอมให้ผู้จัดงานและโรงแรมคู่ค้า
                  ใช้ข้อมูลนี้เพื่อการยืนยันสิทธิ์ตั๋วเข้างาน และการจัดทำรายงานภายในเท่านั้น
                  ข้อมูลจะไม่ถูกขายหรือเปิดเผยต่อบุคคลภายนอกที่ไม่เกี่ยวข้อง
                </p>

                <label class="consent-check">
                  <input type="checkbox" id="consent" required>
                  <span>
                    ฉันได้อ่านและยินยอมให้เก็บและใช้ข้อมูลตามที่ระบุข้างต้น<br>
                    I have read and consent to the data usage described above.
                  </span>
                </label>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="submit-btn">
            ส่งข้อมูลลงทะเบียน • Submit Registration
          </button>

          <div id="message" class="hidden"></div>

          <hr style="margin:24px 0; border:none; border-top:1px solid var(--border);">

          <!-- กล่องค้นหาด้วยชื่อ–นามสกุล -->
          <div class="lookup-box">
            <label class="title">
              ค้นหาข้อมูลจากชื่อ–นามสกุล
              <span class="en-label">/ Lookup Registration by Full Name</span>
            </label>
            <p class="note">
              TH: ใช้สำหรับค้นหาข้อมูลการลงทะเบียนที่เคยบันทึกไว้แล้ว เช่น กรณีลืมแคปหน้าจอ<br>
              EN: Use this to retrieve an existing registration by full name, e.g. if you forgot to take a screenshot.
            </p>

            <div class="row two">
              <div>
                <input id="lookup_first_name" type="text"
                       placeholder="ชื่อจริง / First Name เช่น Somchai หรือ สมชาย">
              </div>
              <div>
                <input id="lookup_last_name" type="text"
                       placeholder="นามสกุล / Last Name เช่น Chan หรือ ชาญ">
              </div>
            </div>

            <button type="button" class="btn btn-primary" id="lookup-btn">
              ค้นหาการลงทะเบียน / Lookup
            </button>

            <div id="lookup-message" class="note" style="margin-top:8px;"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- PAGE 2 : SUCCESS -->
    <div id="page-success" class="hidden">
      <div class="card">
        <div class="head">
          <h1>ลงทะเบียนสำเร็จ / Registration Completed</h1>
          <p>โปรดเก็บข้อมูลด้านล่างไว้เพื่อแสดงสิทธิ์ตั๋ว Complimentary Ticket ของคุณ</p>
        </div>
        <div class="body">
          <div id="confirm-card" class="success">
            <p><strong>ข้อมูลลงทะเบียนของคุณ / Your Registration Details</strong></p>

            <p>
              <strong>ชื่อ–นามสกุล / Full Name:</strong>
              <span id="c-name"></span>
            </p>

            <p>
              <strong>โรงแรมที่เข้าพัก / Hotel:</strong>
              <span id="c-hotel"></span>
            </p>

            <p>
              <strong>Reference ID:</strong>
              <span id="c-ref"></span>
            </p>

            <div class="screenshot-box">
              <strong>TH:</strong>
              กรุณาแคปหน้าจอนี้เก็บไว้ เพื่อแสดงให้เจ้าหน้าที่ตรวจสอบสิทธิ์ตั๋วเข้าชมหน้างาน<br><br>
              <strong>EN:</strong>
              Please take a screenshot of this page and show it to the staff to verify your complimentary ticket at the venue.
            </div>
          </div>

          <button type="button" class="btn btn-secondary" id="new-register-btn">
            ลงทะเบียนใหม่ / New Registration
          </button>
        </div>
      </div>
    </div>

    <div class="footer">
      © 2025 WGP#1 Waterjet World Cup
    </div>
  </main>

<script>
/* Supabase */
const SUPABASE_URL = 'https://mhecpnqwwxspxfhdvzsc.supabase.co';
const SUPABASE_ANON_KEY =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1oZWNwbnF3d3hzcHhmaGR2enNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMDc0MjEsImV4cCI6MjA3ODU4MzQyMX0.ONaEMqU6BHuMSywE3Yvtbj78NqBbecI18amsD18Cgnc';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Elements */
const pageForm      = document.getElementById('page-form');
const pageSuccess   = document.getElementById('page-success');
const form          = document.getElementById('hotel-form');
const submitBtn     = document.getElementById('submit-btn');
const messageBox    = document.getElementById('message');
const countryEl     = document.getElementById('country');
const provinceWrapper = document.getElementById('province-wrapper');
const provinceEl    = document.getElementById('thai_province');

/* Local storage */
function saveLocal(payload) {
  localStorage.setItem("hotel_registration", JSON.stringify(payload));
}
function loadLocal() {
  const data = localStorage.getItem("hotel_registration");
  return data ? JSON.parse(data) : null;
}

/* Province toggle */
function toggleProvince() {
  const isTH = countryEl.value === 'Thailand';
  provinceWrapper.classList.toggle('hidden', !isTH);
  if (!isTH) provinceEl.value = '';
}
countryEl.addEventListener('change', toggleProvince);

/* Fill confirmation card */
function fillConfirmCard(p) {
  document.getElementById('c-name').textContent =
    `${p.first_name || ''} ${p.last_name || ''}`.trim();
  document.getElementById('c-hotel').textContent = p.hotel_name || '-';
  document.getElementById('c-ref').textContent   = p.registration_ref || '-';
}

/* Show success page */
function showSuccessPage(payload) {
  fillConfirmCard(payload);
  pageForm.classList.add('hidden');
  pageSuccess.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* Insert to Supabase (allow duplicate phone) */
async function submitToSupabase(payload) {
  const { error } = await sb
    .from('hotel_complimentary_tickets')
    .insert({
      first_name:       payload.first_name,
      last_name:        payload.last_name,
      gender:           payload.gender,
      age_group:        payload.age_group,
      phone:            payload.phone,
      hotel_name:       payload.hotel_name,
      country:          payload.country,
      thai_province:    payload.thai_province || null,
      consent:          payload.consent,
      registration_ref: payload.registration_ref
    }, { returning: 'minimal' });

  if (error) {
    console.error('[Supabase insert error]', error);
    throw error;
  }
}

/* Reference ID */
function createReference(phone) {
  const now = new Date();
  const y = String(now.getFullYear()).slice(-2);
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const last4 = (phone || '').slice(-4) || '0000';
  return `H-${y}${m}${d}-${last4}`;
}

/* Submit handler */
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  messageBox.className = 'hidden';
  messageBox.textContent = '';

  const payload = {
    first_name:   document.getElementById('first_name').value.trim(),
    last_name:    document.getElementById('last_name').value.trim(),
    gender:       document.getElementById('gender').value,
    age_group:    document.getElementById('age_group').value,
    phone:        document.getElementById('phone').value.trim(),
    hotel_name:   document.getElementById('hotel_name').value.trim(),
    country:      countryEl.value,
    thai_province:provinceEl.value || '',
    consent:      document.getElementById('consent').checked,
  };

  payload.registration_ref = createReference(payload.phone);

  submitBtn.disabled = true;
  submitBtn.textContent = 'กำลังบันทึก... / Submitting...';

  try {
    await submitToSupabase(payload);
    saveLocal(payload);
    showSuccessPage(payload);
    form.reset();
    toggleProvince();
  } catch (err) {
    console.error(err);
    messageBox.className = 'error';
    messageBox.textContent =
      'เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาลองอีกครั้ง หรือแจ้งเจ้าหน้าที่.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'ส่งข้อมูลลงทะเบียน • Submit Registration';
  }
});

/* Lookup by full name */
async function lookupByFullName(firstName, lastName) {
  const { data, error } = await sb
    .from('hotel_complimentary_tickets')
    .select('*')
    .ilike('first_name', `%${firstName}%`)
    .ilike('last_name', `%${lastName}%`)
    .order('id', { ascending: false })
    .limit(1);

  if (error) {
    console.error('[Supabase lookup error]', error);
    return null;
  }
  if (!data || data.length === 0) return null;
  return data[0];
}

const lookupBtn        = document.getElementById('lookup-btn');
const lookupFirstInput = document.getElementById('lookup_first_name');
const lookupLastInput  = document.getElementById('lookup_last_name');
const lookupMessage    = document.getElementById('lookup-message');

lookupBtn.addEventListener('click', async () => {
  const firstName = lookupFirstInput.value.trim();
  const lastName  = lookupLastInput.value.trim();

  lookupMessage.className = 'note';
  lookupMessage.textContent = '';

  if (!firstName || !lastName) {
    lookupMessage.className = 'error';
    lookupMessage.textContent =
      'กรุณากรอกทั้งชื่อ และนามสกุล / Please enter both first name and last name.';
    return;
  }

  lookupMessage.className = 'note';
  lookupMessage.textContent = 'กำลังค้นหา... / Searching...';

  const record = await lookupByFullName(firstName, lastName);

  if (!record) {
    lookupMessage.className = 'error';
    lookupMessage.textContent =
      'ไม่พบข้อมูลการลงทะเบียนด้วยชื่อ–นามสกุลนี้ / No registration found for this full name.';
    return;
  }

  saveLocal(record);
  showSuccessPage(record);

  lookupMessage.className = 'success';
  lookupMessage.textContent =
    'พบข้อมูลการลงทะเบียนแล้ว / Registration found.';
});

/* New Registration button */
document.getElementById('new-register-btn').addEventListener('click', () => {
  pageSuccess.classList.add('hidden');
  pageForm.classList.remove('hidden');
  messageBox.className = 'hidden';
  messageBox.textContent = '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* On load */
document.addEventListener("DOMContentLoaded", () => {
  toggleProvince();
  const data = loadLocal();
  if (data) {
    showSuccessPage(data);
  }
});
</script>
</body>
</html>
